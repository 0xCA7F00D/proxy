# Used for automated builds triggered on Git submits
# Will build envoy and the .deb file and the docker images - all in the current project

# WIP: after the build it will deploy the images into the 'istio-test' cluster, and trigger
# long-running tests

steps:
- name: 'gcr.io/istio-io/istio-builder:0.1'
  args: ['./script/build_repo.sh']
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/proxy_debug', 'bazel-bin/src/envoy/mixer' ]
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', 'bazel-bin/tools/deb/istio-proxy.deb', 'gs://istio/istio-proxy.deb']
- name: 'gcr.io/cloud-builders/kubectl'
  args: ['get', 'pods', '--all-namespaces']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-west1-c'
  - 'CLOUDSDK_CONTAINER_CLUSTER=istio-test'
images:
-  'gcr.io/$PROJECT_ID/proxy_debug'
tags:
- "latest"
options:
  machineType: 'N1_STANDARD_8'
timeout: 1800s
